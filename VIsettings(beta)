<#
.SYNOPSIS
    configure settings for your datacenter as a whole or one setting at a time.
.DESCRIPTION
    A detailed description of the function or script. This keyword can be
    used only once in each topic.
.NOTES
    File Name      : VIsettings(beta).ps1
    Author         : gajendra d ambi
    Prerequisite   : Powercli 5.x, PowerShell V2 over Vista and upper.
    Copyright      - None
.LINK
    Script posted over:
    https://github.com/gajuambi/vmware
#>

#connect to vcenter

connect-viserver
$VMHosts = Get-VMHost | sort
#populate multiple value to the variable below by separating them with commas
$Syslogs = ""
$ntp = ""
$dns = ""
$domain_name = ""
$string = ""
$communities = ""
$snmplocation = ""
$DumpTarget = ""
$TcpipHeapSize = ""
$TcpipHeapMax = ""
$MaxVolumes = ""
$HeartbeatFrequency = ""
$HeartbeatTimeout = ""
$HeartbeatDelta = ""
$HeartbeatMaxFailures = ""

#start syslog function
Function syslog {
get-vmhost | Get-AdvancedSetting -Name Syslog.loggers.hostd.rotate | Set-AdvancedSetting -Value 80 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.loggers.hostd.size | Set-AdvancedSetting -Value 10240 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.loggers.vmkernel.rotate | Set-AdvancedSetting -Value 80 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.loggers.vmkernel.size | Set-AdvancedSetting -Value 10240 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.loggers.fdm.rotate | Set-AdvancedSetting -Value 80 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.loggers.vpxa.rotate | Set-AdvancedSetting -Value 20 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.global.defaultRotate | Set-AdvancedSetting -Value 20 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.global.defaultSize | Set-AdvancedSetting -Value 10240 -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Syslog.global.logHost | Set-AdvancedSetting -Value $Syslogs -Confirm:$false
get-vmhost | Get-VMHostFirewallException -Name "syslog" | Set-VMHostFirewallException -enabled:$true
} #end syslog function

#start ntp function
Function ntp {
get-vmhost | add-vmhostntpserver -ntpserver $ntp
} #end ntp function

#start dns function
Function dns {
get-vmhost | Get-VMHostNetwork | Set-VMHostNetwork -DNSAddress $dns
} #end ntp function

#start domain_name function
Function domain_name {
get-vmhost | Get-VMHostNetwork | Set-VMHostNetwork -DomainName $domain_name
} #end function

#start firewall function
Function firewall {
Get-VmhostFirewallException -VMhost $VMhost -Name "netDump" | Set-VMHostFirewallException -enabled:$true
Get-VmhostFirewallException -VMhost $VMhost -Name "syslog" | Set-VMHostFirewallException -enabled:$true
Get-VmhostFirewallException -VMhost $VMhost -Name "SSH Client" | Set-VMHostFirewallException -enabled:$true
Get-VmhostFirewallException -VMhost $VMhost -Name "NTP Client" | Set-VMHostFirewallException -enabled:$true
Get-VmhostFirewallException -VMhost $VMhost -Name "vCenter Update Manager" | Set-VMHostFirewallException -enabled:$true
} #end firewall function

#start VMSecurity function
Function VMSecurity {
Get-VM | Get-AdvancedSetting -Name "isolation.tools.diskWiper.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.diskShrink.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "RemoteDisplay.maxConnections" | Set-AdvancedSetting -Value "1" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.copy.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.paste.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.setGUIOptions.enable" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.dnd.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.device.connectable.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.device.edit.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "vmci0.unrestricted" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "log.rotateSize" | Set-AdvancedSetting -Value "1000000" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "log.keepOld" | Set-AdvancedSetting -Value "10" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "tools.setInfo.sizeLimit" | Set-AdvancedSetting -Value "1048576" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "guest.command.enabled" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "tools.guestlib.enableHostInfo" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.unity.push.update.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.ghi.launchmenu.change" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "isolation.tools.memSchedFakeSampleStats.disable" | Set-AdvancedSetting -Value "true" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "floppyX.present" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "SerialX.present" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "parallelX.present" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "usb.present" | Set-AdvancedSetting -Value "false" -Confirm:$false
Get-VM | Get-AdvancedSetting -Name "ideX:Y.present" | Set-AdvancedSetting -Value "false" -Confirm:$false
} #end VMSecurity function

#start SNMP function
Function SNMP {
$esxcli = Get-EsxCli
$esxcli.system.snmp.set($null,$communities,"true",$null,$null,$null,$null,$null,$null,$null,$null,$null,$snmplocation)
$esxcli.system.snmp.get()
} #end SNMP function

#Start CoreDump function
Function CoreDump {
Get-VMHost | Set-VMHostDumpCollector -HostVNic "vmk0" -NetworkServerIP $DumpTarget -NetworkServerPort 6500
} #end CoreDump function

#Start funcion TCP
Function TCP {
get-vmhost | Get-AdvancedSetting -Name Net.TcpipHeapSize | Set-AdvancedSetting -Value $TcpipHeapSize -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name Net.TcpipHeapMax | Set-AdvancedSetting -Value $TcpipHeapMax -Confirm:$false
} #end function
#Stop function TCP

#Start funcion NFS
Function NFS {
get-vmhost | Get-AdvancedSetting -Name NFS.MaxVolumes | Set-AdvancedSetting -Value $MaxVolumes -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name NFS.HeartbeatFrequency | Set-AdvancedSetting -Value $HeartbeatFrequency -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name NFS.HeartbeatTimeout | Set-AdvancedSetting -Value $HeartbeatTimeout -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name NFS.HeartbeatDelta | Set-AdvancedSetting -Value $HeartbeatDelta -Confirm:$false
get-vmhost | Get-AdvancedSetting -Name NFS.HeartbeatMaxFailures | Set-AdvancedSetting -Value $HeartbeatMaxFailures -Confirm:$false
} #end function NFS

#Start function SSH_Enable
Function EnableSSH {
Get-VMHost | Get-VMHostService | where {$_.Key -eq "TSM-SSH"} | Start-VMHostService
}
#End function EnableSSH

#Stop function SSH_Disable
Function DisableSSH {
Get-VMHost | Get-VMHostService | where {$_.Key -eq "TSM-SSH"} | Start-VMHostService
}
#End function DisableSSH

#start function MOB
Function MOB {
#Get Plink
$PlinkLocation = $PSScriptRoot + "\Plink.exe"
If (-not (Test-Path $PlinkLocation)){
   Write-Host "Plink.exe not found, trying to download..."
   $WC = new-object net.webclient
   $WC.DownloadFile("http://the.earth.li/~sgtatham/putty/latest/x86/plink.exe",$PlinkLocation)
   If (-not (Test-Path $PlinkLocation)){
      Write-Host "Unable to download plink.exe, please download from the following URL and add it to the same folder as this script: http://the.earth.li/~sgtatham/putty/latest/x86/plink.exe"
      Exit
   } Else {
      $PlinkEXE = Get-ChildItem $PlinkLocation
      If ($PlinkEXE.Length -gt 0) {
         Write-Host "Plink.exe downloaded, continuing script"
      } Else {
         Write-Host "Unable to download plink.exe, please download from the following URL and add it to the same folder as this script: http://the.earth.li/~sgtatham/putty/latest/x86/plink.exe"
         Exit
      }
   }  
}


#If using in powershell then add snapins below
Add-PSSnapin VMware.VimAutomation.Core -ea "SilentlyContinue"

#Connect to the vcenter server
connect-viserver

#copy plink to c:\ for now
Copy-Item $PSScriptRoot\plink.exe C:\

#Variables
$pass = Read-Host "Type the esxi password"
$user = Read-Host "Type the esxi username which is usually root"
$VMHosts = Get-VMHost

##create a shell script on the esxi host
#create a text file on the host with the script
$cmd0 = "echo 'vim-cmd proxysvc/remove_service */mob* *httpsWithRedirect*' >> /tmp/mob.txt"
$cmd1 = "sed -i 's/*/\""/g' /tmp/mob.txt"
#convert the text to a shell script by just renaming
$rename = "mv /tmp/mob.txt /tmp/mob.sh"
#make the shell script executibel
$chmod = "chmod +x /tmp/mob.sh"
#run the mob shell script
$mob = "/tmp/mob.sh"
#remove the shell script
$clean = "rm -rf /tmp/mob.sh"

#Enable SSH on all hosts
Get-VMHost | Get-VMHostService | where {$_.Key -eq "TSM-SSH"} | Start-VMHostService

ForEach ($VMHost in $VMHosts)
{
echo y | C:\plink.exe -ssh $user@$VMHost -pw $pass "exit"
C:\plink.exe -ssh -v -noagent $VMHost -l $user -pw $pass $cmd0
C:\plink.exe -ssh -v -noagent $VMHost -l $user -pw $pass $cmd1
C:\plink.exe -ssh -v -noagent $VMHost -l $user -pw $pass $rename
C:\plink.exe -ssh -v -noagent $VMHost -l $user -pw $pass $chmod
C:\plink.exe -ssh -v -noagent $VMHost -l $user -pw $pass $mob
C:\plink.exe -ssh -v -noagent $VMHost -l $user -pw $pass $clean
}

#Disable SSH on all hosts
Get-VMHost | Get-VMHostService | where {$_.Key -eq "TSM-SSH"} | Stop-VMHostService

#delete plink from c:\
Remove-Item C:\plink.exe

#mob script below
#vim-cmd proxysvc/remove_service "/mob" "httpsWithRedirect"
}
#End function MOB

Write-Host = "Below are your options
1 syslog 
2 ntp
3 dns 
4 domain_name 
5 firewall 
6 VMSecurity 
7 SNMP
8 CoreDump
9 TCP
10 NFS
11 EnableSSH
12 DisableSSH
13 MOB
0 All of the above(except those in 11,12,13)
"
$option = Read-Host "choose a number between 0 to 10"

switch ($option) 
    { 
        1 {syslog} 
        2 {ntp} 
        3 {dns} 
        4 {domain_name} 
        5 {firewall} 
        6 {VMSecurity} 
        7 {SNMP}
        8 {CoreDump}
        9 {TCP}
        10 {NFS}
        11 {EnableSSH}
        12 {DisableSSH}
        13 {MOB}
        0 {
        {syslog}
        {ntp}
        {dns}
        {domain_name}
        {firewall}
        {VMSecurity}
        {SNMP}
        {CoreDump}
        {TCP}
        {NFS}
        }
    }

#End of Script
